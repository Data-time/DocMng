{
 'Реквизиты': {
  'Наименование': 'Интеграция с УПП (Возврат оборудования - Оформлен возврат прибора)',
  'ТекстОбработки': 'ДанныеПодключений = Новый Структура;
Для каждого ДанныеПеременной Из Переменные Цикл
	ДанныеПодключений.Вставить(ДанныеПеременной.Имя, ДанныеПеременной.Значение);
КонецЦикла;

ТипСобытия = Справочники.УМ_ТипыСобытий.ПолучитьТипСобытияПоИдентификатору("ИнтеграцияУПП_ВозвратОборудования_ОформленВозвратПрибора");


Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
		|	ТекущиеСостоянияДокументов.Документ КАК Документ,
		|	ТекущиеСостоянияДокументов.Действие КАК Действие,
		|	DT_Данные_ВозвратОборудования.Идентификатор КАК Идентификатор,
		|	ОбработкиОбъектов.ДатаНачала КАК ДатаНачала
		|ИЗ
		|	РегистрСведений.ТекущиеСостоянияДокументов КАК ТекущиеСостоянияДокументов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.DT_ДопНастройкиВидовДокументов КАК DT_ДопНастройкиВидовДокументов
		|		ПО ТекущиеСостоянияДокументов.Документ.ВидДокумента = DT_ДопНастройкиВидовДокументов.Владелец
		|			И (DT_ДопНастройкиВидовДокументов.ФункционалВозвратаОборудования)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДействияИсполнения КАК ДействияИсполнения
		|		ПО ТекущиеСостоянияДокументов.Действие = ДействияИсполнения.Ссылка
		|			И (ДействияИсполнения.ВидДействия = &ВидДействия)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.DT_Данные_ВозвратОборудования КАК DT_Данные_ВозвратОборудования
		|		ПО ТекущиеСостоянияДокументов.Документ = DT_Данные_ВозвратОборудования.Владелец
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбработкиОбъектов КАК ОбработкиОбъектов
		|		ПО ТекущиеСостоянияДокументов.Документ = ОбработкиОбъектов.Владелец
		|			И (НЕ ОбработкиОбъектов.ПомещенаВИсторию)
		|ГДЕ
		|	ТекущиеСостоянияДокументов.Состояние = &Состояние";
Запрос.УстановитьПараметр("ВидДействия", УМ_ДинамическиеКонстантыПовтИсп.ПолучитьЗначениеДинамическойКонстанты("ВозвратОборудования_ОформлениеВозврата"));
Запрос.УстановитьПараметр("Состояние", Перечисления.СостоянияДокументов.НаИсполнении);
РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();
Пока Выборка.Следующий() Цикл
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("UIDMessage"	, Строка(Новый УникальныйИдентификатор));
	СтруктураДанных.Вставить("GUIDDoc"		, XMLСтрока(Выборка.Документ));
	СтруктураДанных.Вставить("StartDate"	, Выборка.ДатаНачала);
	СтруктураДанных.Вставить("ID"			, Выборка.Идентификатор);
	СтруктураДанных.Вставить("GUIDAction"	, XMLСтрока(Выборка.Действие));
	
	Соединение = Неопределено;
	Если ДанныеПодключений.Свойство("ВозвратОборудования_ОформленВозвратПрибора") Тогда
		Соединение = ДанныеПодключений.ВозвратОборудования_ОформленВозвратПрибора;
	КонецЕсли;
	Если Соединение <> Неопределено Тогда
		НачатьТранзакцию();
		Попытка
			РегистрыСведений.УМ_ОчередьСообщенийКОтправке.ДобавитьСообщение(
				ТипСобытия,
				Соединение,
				СтруктураДанных,
				СтруктураДанных.UIDMessage);	
			
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			
			ТекстОшибки = ОписаниеОшибки();
			
			ЗаписьЖурналаРегистрации(
				"DT_ИнтеграцияСУПП",
				УровеньЖурналаРегистрации.Ошибка,,,
				"Ошибка при интеграции с УПП(возврат оборудования). Не удалось записать новое сообщение для отправки." + Символы.ПС + ТекстОшибки);
		КонецПопытки;
	КонецЕсли;
	
КонецЦикла;
  
УМ_Интеграции.Алгоритм("УПП_ВозвратОборудования_ОформленВозвратПрибора",
	ТипСобытия,
 	"DT_ИнтеграцияСУПП",
 	"УПП(возврат оборудования)");',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'ВозвратОборудования_ОформленВозвратПрибора',
     'Разделитель': null,
     'ЗначениеСтрока': '',
     'Комментарий': ''
    }
   ]
  }
 ]
}
