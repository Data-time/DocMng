{
 'Реквизиты': {
  'Код': '000000002',
  'Наименование': 'Подготовка предрелизов и копий баз 1С',
  'ТекстОбработки': 'ФайлЛога = ПолучитьИмяВременногоФайла("txt"); 
ТД = новый ТекстовыйДокумент; ТД.Записать(ФайлЛога);
               
//подготовка строк  
ПутьКExe = "C:\\\\Program Files\\\\1cv8\\\\8.3.20.1710\\\\bin\\\\1cv8.exe"; // 1cestart не подходит, так как не ожидает возврата выполнения

СтрокаЗапускаКонфигуратора = ПутьКExe + " DESIGNER /S "+Соединение.server+"\\\\"+Соединение.bdname+" /N """+Соединение.user+""" /P """+Соединение.password+""" /DisableUnrecoverableErrorMessage /DisableStartupMessages /DisableStartupDialogs /Out """+ФайлЛога+""" -NoTruncate /uc uh1234";
СтрокаЗапускаПользовательскогоРежима = СтрЗаменить(СтрокаЗапускаКонфигуратора,"DESIGNER","ENTERPRISE"); 
ДопСтрокаПодключенияКХранилищу = " /ConfigurationRepositoryF """+Соединение.ConfRep+""" /ConfigurationRepositoryN """+Соединение.ConfRepUser+""" /ConfigurationRepositoryP """+Соединение.ConfRepPassword+"""";
ДопСтрокаПодключенияКХранилищуРасширения = " /ConfigurationRepositoryF """+Соединение.ConfRep_Cfe+""" /ConfigurationRepositoryN """+Соединение.ConfRep_CfeUser+""" /DisableUnrecoverableErrorMessage /DisableStartupMessages /ConfigurationRepositoryP """+Соединение.ConfRep_CfePassword+"""";
   
МассивШаговСОшибками = новый Массив;  

Перем = Истина;
      
//1. Отключение от хранилища      
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"1. Отключение от хранилища " + ТекущаяДата());ТД.Записать(ФайлЛога); 
Скрипт = СтрокаЗапускаКонфигуратора + " /ConfigurationRepositoryUnbindCfg -force";  
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("1"); КонецЕсли;


//2. Отключение от хранилища расширения 
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"2. Отключение от хранилища рсширения " + ТекущаяДата());ТД.Записать(ФайлЛога);
Скрипт = СтрокаЗапускаКонфигуратора + " /ConfigurationRepositoryUnbindCfg -Extension """+Соединение.ConfRep_CfeName+""" -force";
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("2"); КонецЕсли;


//3.Подключение к хранилищу
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"3. Подключение к хранилищу " + ТекущаяДата());ТД.Записать(ФайлЛога);
Скрипт = СтрокаЗапускаКонфигуратора + ДопСтрокаПодключенияКХранилищу + " /ConfigurationRepositoryBindCfg -forceBindAlreadyBindedUser -forceReplaceCfg";                 
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("3"); КонецЕсли;


//4. Подключение к хранилищу расширения
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"4. Подключение к хранилищу расширения " + ТекущаяДата());ТД.Записать(ФайлЛога);
Скрипт = СтрокаЗапускаКонфигуратора + ДопСтрокаПодключенияКХранилищуРасширения + " /ConfigurationRepositoryBindCfg -Extension """+Соединение.ConfRep_CfeName+""" -forceBindAlreadyBindedUser -forceReplaceCfg";
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("4"); КонецЕсли;

//5. Обновление из хранилища 
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"5. Обновление из хранилища " + ТекущаяДата());ТД.Записать(ФайлЛога);
Скрипт = СтрокаЗапускаКонфигуратора + ДопСтрокаПодключенияКХранилищу + " /ConfigurationRepositoryUpdateCfg -force /UpdateDBCfg -Server";
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("5"); КонецЕсли;
 

ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"6. Обновление из хранилища расширения " + ТекущаяДата());ТД.Записать(ФайлЛога);
Скрипт = СтрокаЗапускаКонфигуратора + ДопСтрокаПодключенияКХранилищуРасширения + " /ConfigurationRepositoryUpdateCfg -Extension """+Соединение.ConfRep_CfeName+""" -force /UpdateDBCfg -Server";
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("6"); КонецЕсли;
  
//7.  в пользовательском режиме  
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"7. Изоляция в пользовательском режиме " + ТекущаяДата());ТД.Записать(ФайлЛога); 
Скрипт = СтрокаЗапускаПользовательскогоРежима + " /AllowExecuteScheduledJobs –Off /CТ1ПодготовкаКопии_"+Соединение.ТипПодготовки+" ";
КодВозврата = Неопределено; ЗапуститьПриложение(Скрипт,,Истина,КодВозврата);
Если КодВозврата <> 0 Тогда МассивШаговСОшибками.Добавить("7"); КонецЕсли;
 
 
ТД.Прочитать(ФайлЛога);ТД.ДобавитьСтроку(Символы.ПС+"Завершение " + ТекущаяДата());ТД.Записать(ФайлЛога); 
     
     
ТД.Прочитать(ФайлЛога); 
ТекстЛога = ТД.ПолучитьТекст();
 
Если МассивШаговСОшибками.Количество() > 0 Тогда 
	Успешно = Ложь;
	СтрокаОшибок = СтрокаОшибок + "Подготовка копии завершена с ошибками на этапах: "+СтрСоединить(МассивШаговСОшибками,", ")+Символы.ПС;
КонецЕсли;
СтрокаОшибок = СтрокаОшибок + ТекстЛога;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'NtcnGthtvtyyjq',
     'Разделитель': null,
     'ЗначениеСтрока': 'qwerf  fwef',
     'Комментарий': 'Комментывф'
    }
   ]
  }
 ]
}
