{
 'Реквизиты': {
  'Наименование': 'Контроль - заполнение AD (из DWH)',
  'ТекстОбработки': '//-----------------------------------------------------------------
//Параметры выгрузки
//-----------------------------------------------------------------
Отладка = Ложь;
ПочтаПолучателей = "support@t-medica.com;ssmirnov@t-medica.com";   
	 
ГуидУчетнойЗаписиПочты = "567e3146-123f-11ed-a12c-ef295ee2b5a3"; //предопределенная
	 
Если Отладка Тогда 
    ПочтаПолучателей = "ssmirnov@t-medica.com";
КонецЕсли;  

ДатаНачалаВыгрузки = ТекущаяДата();
СимволПереносаСтроки = Символы.ПС; //+ Символы.ВК;
ТемаСообщения = "Неправильно заведенные пользователи AD """+Система+""" от "+Формат(ДатаНачалаВыгрузки,"ДФ=dd.MM.yyyy"); 
ТекстСообщения = "Выполняются проверки """+Система+""":"+СимволПереносаСтроки+
	"	1. Не заполнен EmployeeID у активных пользователей в "+Соединение.OUWorker + "," + Соединение.DC+СимволПереносаСтроки+
	"		Решение: заполнить EmployeeID"+СимволПереносаСтроки+
	"	2. Заблокированный пользователь в "+Соединение.OUWorker + "," + Соединение.DC+СимволПереносаСтроки+   
	"		Решение: перенести заблокированного пользователя в OU Disabled"+СимволПереносаСтроки+
	"	3. Уволенный сотрудник в "+Соединение.OUWorker + "," + Соединение.DC + СимволПереносаСтроки+
	"		Решение: Заблокировать запись или перенести в OU External"+СимволПереносаСтроки+
	СимволПереносаСтроки + "Найденные ошибки:";
	
//-----------------------------------------------------------------  
//Служебные параметры  
//----------------------------------------------------------------- 
СистемаGUID = XMLСтрока(Система); 

СоединениеDWH = ПолучитьЗначениеПеременной(Переменные,"СоединениеDWH");
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не заполнен параметр СоединениеDWH";
КонецЕсли;
СоединениеDWH = ПолучитьСоединениеПоПодключению(СоединениеDWH,СтрокаОшибок);
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не выполнено соединение к DWH";
КонецЕсли;
	
//-----------------------------------------------------------------  
//Выполнение  
//----------------------------------------------------------------- 
НомерОшибки = 0;// общий счетчик

//1 - сотрудники без EmployeeID
ТекстЗапросаБезEID = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапросаБезEID");
ТекстЗапросаБезEID = СтрЗаменить(ТекстЗапросаБезEID,"&СистемаGUID",СистемаGUID); 
FilterOU = Соединение.OUWorker + "," + Соединение.DC;  
ТекстЗапросаБезEID = СтрЗаменить(ТекстЗапросаБезEID,"&FilterOU",FilterOU);

ЗаписиSQL = СоединениеDWH.Execute(ТекстЗапросаБезEID);		
Если ЗаписиSQL.State = 1 Тогда 
	Пока ЗаписиSQL.EOF = 0 Цикл 
		НомерОшибки = НомерОшибки + 1;
		
		ADsPath = ЗаписиSQL.Fields("ADsPath").Value;	
		DisplayName = ЗаписиSQL.Fields("DisplayName").Value;  
		
		ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + Символы.Таб + НомерОшибки+ "." +Символы.Таб + "Не заполнен EmployeeID: "+DisplayName+" ("+ADsPath+")";
		
		
		Если НомерОшибки >= 100 Тогда //ТОП 100
			ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + СимволПереносаСтроки + "Прервано, так как количество >100"; 
			Прервать;
		КонецЕсли;
		ЗаписиSQL.MoveNext();
								
	КонецЦикла; 
КонецЕсли;
	
//2 - Только активные пользователи
ТекстЗапросаТолькоАктивные = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапросаТолькоАктивные");
ТекстЗапросаТолькоАктивные = СтрЗаменить(ТекстЗапросаТолькоАктивные,"&СистемаGUID",СистемаGUID); 
FilterOU = Соединение.OUWorker + "," + Соединение.DC;  
ТекстЗапросаТолькоАктивные = СтрЗаменить(ТекстЗапросаТолькоАктивные,"&FilterOU",FilterOU);
ЗаписиSQL = СоединениеDWH.Execute(ТекстЗапросаТолькоАктивные);		
Если ЗаписиSQL.State = 1 Тогда 
	Пока ЗаписиSQL.EOF = 0 Цикл 
		НомерОшибки = НомерОшибки + 1;
		
		ADsPath = ЗаписиSQL.Fields("ADsPath").Value;	
		DisplayName = ЗаписиSQL.Fields("DisplayName").Value;  
		
		ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + Символы.Таб + НомерОшибки+ "." +Символы.Таб + "Заблокированный пользователь в OU работающих: "+DisplayName+" ("+ADsPath+")";
		
		
		Если НомерОшибки >= 100 Тогда //ТОП 100
			ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + СимволПереносаСтроки + "Прервано, так как количество >100"; 
			Прервать;
		КонецЕсли;
		ЗаписиSQL.MoveNext();
								
	КонецЦикла; 
КонецЕсли; 

//3 - Только работающие сотрудники
ТекстЗапросаТолькоРаботающие = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапросаТолькоРаботающие");
ТекстЗапросаТолькоРаботающие = СтрЗаменить(ТекстЗапросаТолькоРаботающие,"&СистемаGUID",СистемаGUID); 
FilterOU = Соединение.OUWorker + "," + Соединение.DC;  
ТекстЗапросаТолькоРаботающие = СтрЗаменить(ТекстЗапросаТолькоРаботающие,"&FilterOU",FilterOU);
ЗаписиSQL = СоединениеDWH.Execute(ТекстЗапросаТолькоРаботающие);		
Если ЗаписиSQL.State = 1 Тогда 
	Пока ЗаписиSQL.EOF = 0 Цикл 
		НомерОшибки = НомерОшибки + 1;
		
		ADsPath = ЗаписиSQL.Fields("ADsPath").Value;	
		DisplayName = ЗаписиSQL.Fields("DisplayName").Value;  
		
		ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + Символы.Таб + НомерОшибки+ "." +Символы.Таб + "Уволенный сотрудник в OU работающих: "+DisplayName+" ("+ADsPath+")";
		
		
		Если НомерОшибки >= 100 Тогда //ТОП 100
			ТекстСообщения = ТекстСообщения + СимволПереносаСтроки + СимволПереносаСтроки + "Прервано, так как количество >100"; 
			Прервать;
		КонецЕсли;
		ЗаписиSQL.MoveNext();
								
	КонецЦикла; 
КонецЕсли;
	 
//Отправка письма
Если НомерОшибки > 0 Тогда
	Алгоритм("ОтправитьEmail",ЗапросСсылка,ПочтаПолучателей,ТемаСообщения,ТекстСообщения,ТипТекстаПочтовогоСообщения.ПроизвольныйТекст,ГуидУчетнойЗаписиПочты); 
	СтрокаОшибок = СтрокаОшибок + ""+Система+" - сообщения отправлены"+Символы.ПС;
Иначе
	СтрокаОшибок = СтрокаОшибок + ""+Система+" - нет данных для отправки"+Символы.ПС;
КонецЕсли; 

Если не Отладка Тогда
	УстановитьДатуПоследнейВыгрузки(Система,ЗапросСсылка,ДатаНачалаВыгрузки);
КонецЕсли;',
  'Комментарий': 'Писем - по количеству систем AD
ВАЖНО! - выполнять после загроузки AD в DWH

использую сводный запрос с 07.02.2024'
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'СоединениеDWH',
     'Разделитель': null,
     'ЗначениеСтрока': '',
     'Комментарий': ''
    },
    {
     'Имя': 'ТекстЗапросаБезEID',
     'Разделитель': null,
     'ЗначениеСтрока': 'SELECT 
	[ADsPath]
	,[DisplayName]
FROM [DWH].[dbo].[AD]
WHERE
	Система = \u0027&СистемаGUID\u0027 
	AND ADsPath like \u0027%&FilterOU%\u0027
	AND isnull(employeeID,\u0027\u0027) = \u0027\u0027',
     'Комментарий': ''
    },
    {
     'Имя': 'ТекстЗапросаТолькоАктивные',
     'Разделитель': null,
     'ЗначениеСтрока': 'SELECT 
	[ADsPath]
	,[DisplayName]
FROM [DWH].[dbo].[AD]
WHERE
	Система = \u0027&СистемаGUID\u0027 
	AND ADsPath like \u0027%&FilterOU%\u0027
	AND isActive = 0',
     'Комментарий': ''
    },
    {
     'Имя': 'ТекстЗапросаТолькоРаботающие',
     'Разделитель': null,
     'ЗначениеСтрока': 'SELECT 
      [ADsPath]
      ,[DisplayName]
	  ,УвПоEID.Уволен

  FROM [DWH].[dbo].[AD] as AD
  
  INNER JOIN
	(SELECT ФизическиеЛица.employeeID,
		CASE
			WHEN MIN(ДатаУвольнения) = \u00270001-01-01\u0027 or MAX(ДатаУвольнения) >= DATEADD(day,-7,GETDATE()) THEN 0 --не уволена или с увольнения прошло более 7 дней
			ELSE 1
		END AS Уволен
	   FROM dbo.Сотрудники AS Сотрудники_1
	   INNER JOIN dbo.ФизическиеЛица AS ФизическиеЛица ON Сотрудники_1.ФизЛицоUUID = ФизическиеЛица.UUID
	   GROUP BY ФизическиеЛица.employeeID) AS УвПоEID

   ON AD.employeeID = УвПоEID.EmployeeID

   WHERE 
	Система = \u0027&СистемаGUID\u0027 
	AND ADsPath like \u0027%&FilterOU%\u0027
	AND УвПоEID.Уволен = 1',
     'Комментарий': ''
    }
   ]
  }
 ]
}
