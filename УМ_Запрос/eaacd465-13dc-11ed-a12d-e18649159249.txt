{
 'Реквизиты': {
  'Наименование': 'Выгрузка В AD',
  'ТекстОбработки': '//-----------------------------------------------------------------
//Параметры выгрузки
//-----------------------------------------------------------------
Отладка = Ложь;
Отладка_EmployeeID = "1026113914";

//-----------------------------------------------------------------  
//Служебные параметры  
//----------------------------------------------------------------- 

ДатаЗагрузки = ТекущаяДата();
СистемаGUID = XMLСтрока(Система); 
ТекстЗапросаSQL = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапросаSQL"); 
ТекстЗапросаSQL = СтрЗаменить(ТекстЗапросаSQL,"&СистемаGUID",XMLСтрока(Система));

СоединениеDWH = ПолучитьЗначениеПеременной(Переменные,"СоединениеDWH");
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не заполнен параметр СоединениеDWH";
КонецЕсли;
СоединениеDWH = ПолучитьСоединениеПоПодключению(СоединениеDWH,СтрокаОшибок);
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не выполнено соединение к DWH";
КонецЕсли; 

Обработано = 0;
Добавлено = 0;
Обновлено = 0;
Удалено = 0;
	
//-----------------------------------------------------------------  
//Выполнение  
//----------------------------------------------------------------- 
	  
Если Отладка и ЗначениеЗаполнено(Отладка_EmployeeID) Тогда   
	ТекстЗапросаSQL = ТекстЗапросаSQL + " and AD.EmployeeID = \u0027"+Отладка_EmployeeID+"\u0027";
КонецЕсли;	  
	  
dso = ПолучитьCOMОбъект("LDAP:");
ТекПарольАД = Соединение.Connection.Properties("password").Value;
ТекПользовательАД = Соединение.Connection.Properties("user id").Value;
	
МассивСвойствОбновления = Новый Массив;	
МассивСвойствОбновления.Добавить("title");
МассивСвойствОбновления.Добавить("department");
МассивСвойствОбновления.Добавить("company");
МассивСвойствОбновления.Добавить("DisplayName");


		              
ЗаписиSQL = СоединениеDWH.Execute(ТекстЗапросаSQL);		
Пока ЗаписиSQL.EOF=0 Цикл
	Обработано = Обработано + 1;
	ADsPath = ЗаписиSQL.Fields("ADsPath").Value;	
	obj = dso.OpenDSObject(ADsPath, ТекПользовательАД, ТекПарольАД, 0);
	
	 
	
	Для Каждого ИмяРеквизита ИЗ МассивСвойствОбновления Цикл 
		ЗначениеРеквизита = ЗаписиSQL.Fields(ИмяРеквизита).Value;
		Если УМ_ОбщегоНазначенияСервер.ЭтоПустоеЗначение(ЗначениеРеквизита) Тогда
			//очистить в кеше
			obj.PutEx(1,ИмяРеквизита,ЗначениеРеквизита);
		Иначе
			//изменить в кеше
			obj.Put(ИмяРеквизита,ЗначениеРеквизита);
		КонецЕсли;  
	КонецЦикла;
	
	obj.SetInfo(); //записать изменения
	 	         
	//CN и Name изменяется только перемещением
	CN_1С = ЗаписиSQL.Fields("cn").Value;
	CN_AD = ЗаписиSQL.Fields("AD_cn").Value; 
	Если CN_1С <> CN_AD Тогда
		НовыйADsPath = СтрЗаменить(ADsPath,"CN="+CN_AD+","   ,   "CN="+CN_1С+",");
		OUADsPath = СтрЗаменить(ADsPath,"CN="+CN_AD+",","");
		Если НовыйADsPath = ADsPath Тогда
			СтрокаОшибок = СтрокаОшибок + "Не удалось вычислить новый ADsPath";
			Успешно = Ложь; 
		Иначе 
			objOU = dso.OpenDSObject(OUADsPath, ТекПользовательАД, ТекПарольАД, 0);
			newobj = objOU.MoveHere(ADsPath,"CN="+CN_1С);
		КонецЕсли; 
			
	КонецЕсли;
	
	Обновлено = Обновлено + 1;  
	
	Если Отладка Тогда 
		Сообщить(ЗаписиSQL.Fields("DisplayName").Value);
		Прервать; 
	КонецЕсли;
	
	ЗаписиSQL.MoveNext(); 
	
КонецЦикла;
	
 
	
  
Если не Отладка Тогда
	УстановитьДатуПоследнейВыгрузки(Система,ЗапросСсылка,ДатаЗагрузки);
КонецЕсли; 

СтрокаОшибок = СтрокаОшибок + ?(СтрокаОшибок="","",Символы.ПС)+ Система +  " Обработано - "+Обработано+". Добавлено - "+Добавлено+". Обновлено - "+Обновлено+". Удалено - "+Удалено;',
  'Комментарий': 'ВАЖНО: сравнение идет по данным DWH. До выполнения данные AD  в DWH олжны быть обновлены'
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'ТекстЗапросаSQL',
     'Разделитель': null,
     'ЗначениеСтрока': 'SELECT 
    AD.ADsPath,
    Данные1С.title,
    Данные1С.company,
    Данные1С.department,
    Данные1С.DisplayName,
    Данные1С.cn,
    AD.cn as AD_cn

FROM (SELECT        
    Организации.Наименование AS company, 
    Подразделения.Наименование AS department, 
    ФизическиеЛица.EmployeeID, 
    ФизическиеЛица.ИНН, 
    ФизическиеЛица.Наименование AS DisplayName,
    ФизическиеЛица.Наименование AS cn,
    Сотрудники.Должность AS title, 
    Сотрудники.ВидЗанятости, 
    Сотрудники.ВидЗанятостиКод, 
    Сотрудники.ДатаПриемаНаРаботу, 
    Сотрудники.ДатаУвольнения

FROM
    dbo.ФизическиеЛица AS ФизическиеЛица 
        INNER JOIN ЛучшиеСотрудникиПоEmployeeID AS ЛучшиеСотрудникиПоEmployeeID ON ЛучшиеСотрудникиПоEmployeeID.EmployeeID = ФизическиеЛица.EmployeeID
        INNER JOIN dbo.Сотрудники AS Сотрудники ON ЛучшиеСотрудникиПоEmployeeID.СотрудникUUID = Сотрудники.UUID 
        INNER JOIN dbo.Организации AS Организации ON Организации.UUID = Сотрудники.ОрганизацияUUID
        
        LEFT OUTER JOIN dbo.Подразделения AS Подразделения ON Подразделения.UUID = Сотрудники.ПодразделениеUUID


where ФизическиеЛица.EmployeeID is not null) AS Данные1С
INNER JOIN dbo.AD AS AD ON Данные1С.EmployeeID = AD.EmployeeID

and AD.Система = \u0027&СистемаGUID\u0027
and AD.IsActive = 1
and (
AD.title <> Данные1С.title 
or AD.company <> Данные1С.company 
or AD.department <> Данные1С.department
or AD.DisplayName <> Данные1С.DisplayName
or AD.cn <> Данные1С.cn
)',
     'Комментарий': ''
    },
    {
     'Имя': 'СоединениеDWH',
     'Разделитель': 'e1cib/data/Справочник.УМ_ИнформационныеБазы?ref=00000000000000000000000000000000',
     'ЗначениеСтрока': '',
     'Комментарий': ''
    }
   ]
  }
 ]
}
