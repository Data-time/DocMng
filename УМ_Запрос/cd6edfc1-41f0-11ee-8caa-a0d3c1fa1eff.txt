{
 'Реквизиты': {
  'Код': '000000034',
  'Наименование': 'Интеграция с УПП (согласование отказных позиций)',
  'ТекстОбработки': 'ДанныеПодключений = Новый Структура;
Для каждого ДанныеПеременной Из Переменные Цикл
	//Если ДанныеПеременной.Разделитель <> Система Тогда
	//	Продолжить;	
	//КонецЕсли;
	
	ДанныеПодключений.Вставить(ДанныеПеременной.Имя, ДанныеПеременной.Значение);
КонецЦикла;

ТипСобытия_ИнтеграцияУПП_СогласованиеОтказныхПозиций = Справочники.УМ_ТипыСобытий.ПолучитьТипСобытияПоИдентификатору("ИнтеграцияУПП_СогласованиеОтказныхПозиций");
	
Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	DT_ДО_ВнешниеСистемы.Ссылка КАК Ссылка
	|ИЗ
	|	ПланОбмена.DT_ДО_ВнешниеСистемы КАК DT_ДО_ВнешниеСистемы
	|ГДЕ
	|	DT_ДО_ВнешниеСистемы.ВыгружатьСогласованиеОтказныхПозиций
	|	И НЕ DT_ДО_ВнешниеСистемы.ПометкаУдаления
	|	И НЕ DT_ДО_ВнешниеСистемы.ЭтотУзел";
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	Узел = ВыборкаДетальныеЗаписи.Ссылка;
	ВыборкаИзменений = ПланыОбмена.ВыбратьИзменения(Узел, Узел.НомерОтправленного);
	
	СообщениеСформировано = Ложь;
	
	Пока ВыборкаИзменений.Следующий() Цикл
	
		РегОбъект = ВыборкаИзменений.Получить();

		Если ТипЗнч(РегОбъект) = Тип("РегистрСведенийНаборЗаписей.ТекущиеСостоянияДокументов") Тогда
			
			Документ = РегОбъект.Отбор.Документ.Значение;
			
			НастройкиПоВидуДокумента = DT_ОбщегоНазначениеПовтИсп.ПолучитьНастройкиПоВидуДокумента(Документ.ВидДокумента);
		
			Если НастройкиПоВидуДокумента.ФункционалСогласованияОтказныхПозиций Тогда
			
				СтруктураДанных = Новый Структура;
				СтруктураДанных.Вставить("UIDMessage", 	Строка(Новый УникальныйИдентификатор));
				СтруктураДанных.Вставить("GUIDDoc", 	Строка(Документ.УникальныйИдентификатор()));
				СтруктураДанных.Вставить("Status",		Строка(РегОбъект.Отбор.Состояние.Значение));
				
				Соединение = Неопределено;
				Если ДанныеПодключений.Свойство("СогласованиеОтказныхПозиций_СтатусДокумента") Тогда
					Соединение = ДанныеПодключений.СогласованиеОтказныхПозиций_СтатусДокумента;
				КонецЕсли;
				Если Соединение <> Неопределено Тогда
					СообщениеСформировано = Истина;
				КонецЕсли;
				
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(РегОбъект) = Тип("СправочникОбъект.ДокументыПредприятия") Тогда
			
			Документ = РегОбъект.Ссылка;
			НастройкиПоВидуДокумента = DT_ОбщегоНазначениеПовтИсп.ПолучитьНастройкиПоВидуДокумента(Документ.ВидДокумента);
		
			Если НастройкиПоВидуДокумента.ФункционалСогласованияОтказныхПозиций Тогда
			
				СтруктураДанных = Новый Структура;
				СтруктураДанных.Вставить("UIDMessage", 	Строка(Новый УникальныйИдентификатор));
				СтруктураДанных.Вставить("GUIDDoc", 	Строка(Документ.УникальныйИдентификатор()));
				
				МассивДанныхПоСтрокам = Новый Массив;
				СсылкаНаДопДанные = DT_ОбщегоНазначенияСерверВызовСервера.ПолучитьСсылкуНаДопДанныеДокумента(Документ, "DT_Данные_СогласованиеОтказныхПозиций");	
				Если ЗначениеЗаполнено(СсылкаНаДопДанные) Тогда
					Для каждого СтрокаТЧ Из СсылкаНаДопДанные.Товары Цикл
						
						СтруктураДанныхСтроки = Новый Структура;
						СтруктураДанныхСтроки.Вставить("IDRow", Строка(СтрокаТЧ.ИдентификаторСтроки));
						СтруктураДанныхСтроки.Вставить("Count", Строка(СтрокаТЧ.КоличествоОтказ));
						
						МассивДанныхПоСтрокам.Добавить(СтруктураДанныхСтроки);

					КонецЦикла;
				КонецЕсли;
				СтруктураДанных.Вставить("Goods", МассивДанныхПоСтрокам);
				
				Соединение = Неопределено;
				Если ДанныеПодключений.Свойство("СогласованиеОтказныхПозиций_ДанныеПоДокументу") Тогда
					Соединение = ДанныеПодключений.СогласованиеОтказныхПозиций_ДанныеПоДокументу;
				КонецЕсли;
				Если Соединение <> Неопределено Тогда
					СообщениеСформировано = Истина;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если СообщениеСформировано Тогда
			НачатьТранзакцию();
			Попытка
				РегистрыСведений.УМ_ОчередьСообщенийКОтправке.ДобавитьСообщение(
					ТипСобытия_ИнтеграцияУПП_СогласованиеОтказныхПозиций,
					Соединение,
					СтруктураДанных,
					СтруктураДанных.UIDMessage);	
				
				//Снимем регистрацию с плана обмена
				ПланыОбмена.УдалитьРегистрациюИзменений(Узел, РегОбъект);
				
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				
				ЗаписьЖурналаРегистрации(
					"DT_ИнтеграцияСУПП",
					УровеньЖурналаРегистрации.Ошибка,,,
					"Ошибка при интеграции с УПП(согласование отказных позиций). Не удалось записать новое сообщение для отправки и снять регистрацию с узла обмена.");
			КонецПопытки;
		КонецЕсли;
		
	КонецЦикла;
		
КонецЦикла;
   
Алгоритм("ОтправитьСообщениеВУХпоТипуСобытия",
	ТипСобытия_ИнтеграцияУПП_СогласованиеОтказныхПозиций,
 	"DT_ИнтеграцияСУПП",
 	"УПП(согласование отказных позиций)");	
',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'СогласованиеОтказныхПозиций_СтатусДокумента',
     'Разделитель': 'e1cib/data/Справочник.УМ_ИнформационныеБазы?ref=8caaa0d3c1fa1eff11ee4251046d583a',
     'ЗначениеСтрока': '',
     'Комментарий': ''
    },
    {
     'Имя': 'СогласованиеОтказныхПозиций_ДанныеПоДокументу',
     'Разделитель': 'e1cib/data/Справочник.УМ_ИнформационныеБазы?ref=8caaa0d3c1fa1eff11ee4251046d583a',
     'ЗначениеСтрока': '',
     'Комментарий': ''
    }
   ]
  }
 ]
}
