{
 'Реквизиты': {
  'Наименование': 'Интеграция с УПП (Возврат оборудования - Статус документа)',
  'ТекстОбработки': 'ДанныеПодключений = Новый Структура;
Для каждого ДанныеПеременной Из Переменные Цикл
	ДанныеПодключений.Вставить(ДанныеПеременной.Имя, ДанныеПеременной.Значение);
КонецЦикла;

ТипСобытия = Справочники.УМ_ТипыСобытий.ПолучитьТипСобытияПоИдентификатору("ИнтеграцияУПП_ВозвратОборудования");

Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТекущиеСостоянияДокументовИзменения.Документ КАК Документ,
	|	ТекущиеСостоянияДокументовИзменения.Узел КАК Узел,
	|	ТекущиеСостоянияДокументовИзменения.Состояние КАК Состояние,
	|	ТекущиеСостоянияДокументовИзменения.Действие КАК Действие
	|ПОМЕСТИТЬ ВТ_ДокументыВозврата
	|ИЗ
	|	РегистрСведений.ТекущиеСостоянияДокументов.Изменения КАК ТекущиеСостоянияДокументовИзменения
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланОбмена.DT_ДО_ВнешниеСистемы КАК DT_ДО_ВнешниеСистемы
	|		ПО (ТекущиеСостоянияДокументовИзменения.Узел = DT_ДО_ВнешниеСистемы.Ссылка)
	|			И (DT_ДО_ВнешниеСистемы.ВыгружатьВозвратОборудования)
	|			И (НЕ DT_ДО_ВнешниеСистемы.ЭтотУзел)
	|			И (НЕ DT_ДО_ВнешниеСистемы.ПометкаУдаления)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.DT_ДопНастройкиВидовДокументов КАК DT_ДопНастройкиВидовДокументов
	|		ПО (ТекущиеСостоянияДокументовИзменения.Документ.ВидДокумента = DT_ДопНастройкиВидовДокументов.Владелец)
	|			И (DT_ДопНастройкиВидовДокументов.ФункционалВозвратаОборудования)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДокументовПредприятия.СостояниеОбработки КАК СостояниеОбработки,
	|	DT_Данные_ВозвратОборудования.Идентификатор КАК Идентификатор,
	|	ВТ_ДокументыВозврата.Документ КАК Документ,
	|	ВТ_ДокументыВозврата.Узел КАК Узел,
	|	ВТ_ДокументыВозврата.Состояние КАК Состояние,
	|	ВТ_ДокументыВозврата.Действие КАК Действие
	|ИЗ
	|	ВТ_ДокументыВозврата КАК ВТ_ДокументыВозврата
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеДокументовПредприятия КАК ДанныеДокументовПредприятия
	|		ПО (ДанныеДокументовПредприятия.Документ = ВТ_ДокументыВозврата.Документ)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.DT_Данные_ВозвратОборудования КАК DT_Данные_ВозвратОборудования
	|		ПО (DT_Данные_ВозвратОборудования.Владелец = ВТ_ДокументыВозврата.Документ)";
РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();
Пока Выборка.Следующий() Цикл
	
	СообщениеСформировано = Ложь;
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("UIDMessage"	, Строка(Новый УникальныйИдентификатор));
	СтруктураДанных.Вставить("GUIDDoc"		, XMLСтрока(Выборка.Документ));
	СтруктураДанных.Вставить("Status"		, Строка(Выборка.СостояниеОбработки));
	СтруктураДанных.Вставить("ID"			, Выборка.Идентификатор);
	
	Соединение = Неопределено;
	Если ДанныеПодключений.Свойство("ВозвратОборудования_СтатусДокумента") Тогда
		Соединение = ДанныеПодключений.ВозвратОборудования_СтатусДокумента;
	КонецЕсли;
	Если Соединение <> Неопределено Тогда
		СообщениеСформировано = Истина;
	КонецЕсли;
				
	Если СообщениеСформировано Тогда
		НачатьТранзакцию();
		Попытка
			РегистрыСведений.УМ_ОчередьСообщенийКОтправке.ДобавитьСообщение(
				ТипСобытия,
				Соединение,
				СтруктураДанных,
				СтруктураДанных.UIDMessage);	
				
			НЗаписи = РегистрыСведений.ТекущиеСостоянияДокументов.СоздатьНаборЗаписей();
			НЗаписи.Отбор.Документ.Установить(Выборка.Документ);
			НЗаписи.Отбор.Действие.Установить(Выборка.Действие);
			НЗаписи.Отбор.Состояние.Установить(Выборка.Состояние);
			НЗаписи.Прочитать();
			
			//Снимем регистрацию с плана обмена
			ПланыОбмена.УдалитьРегистрациюИзменений(Выборка.Узел, НЗаписи);
			
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
		
			ТекстОшибки = ОписаниеОшибки();
		
			ЗаписьЖурналаРегистрации(
				"DT_ИнтеграцияСУПП",
				УровеньЖурналаРегистрации.Ошибка,,,
				"Ошибка при интеграции с УПП(возврат оборудования). Не удалось записать новое сообщение для отправки." + Символы.ПС + ТекстОшибки);
		КонецПопытки;
	КонецЕсли;
		
КонецЦикла;
   
УМ_Интеграции.Алгоритм("ОтправитьСообщениеВУППпоТипуСобытия",
	ТипСобытия,
 	"DT_ИнтеграцияСУПП",
 	"УПП(возврат оборудования)");',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'ВозвратОборудования_СтатусДокумента',
     'Разделитель': null,
     'ЗначениеСтрока': '',
     'Комментарий': ''
    }
   ]
  }
 ]
}
