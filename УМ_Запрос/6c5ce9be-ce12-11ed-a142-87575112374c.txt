{
 'Реквизиты': {
  'Наименование': 'Загрузка настроек рассылки ДР DWH',
  'ТекстОбработки': '//-----------------------------------------------------------------
//Параметры выгрузки
//-----------------------------------------------------------------
Отладка = Ложь; 

//-----------------------------------------------------------------  
//Служебные параметры  
//----------------------------------------------------------------- 

ДатаЗагрузки = ТекущаяДата();
СистемаGUID = XMLСтрока(Система); 
ТекстЗапроса = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапроса");
СоединениеDWH = ПолучитьЗначениеПеременной(Переменные,"СоединениеDWH");
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не заполнен параметр СоединениеDWH";
КонецЕсли;
СоединениеDWH = ПолучитьСоединениеПоПодключению(СоединениеDWH,СтрокаОшибок);
Если СоединениеDWH = неопределено Тогда
	ВызватьИсключение "Не выполнено соединение к DWH";
КонецЕсли;
	
//------------------------------------------------------------------------------
//Запрос в базу
//------------------------------------------------------------------------------ 
Код1СДляИсистемы = ПолучитьЗначениеПеременной(Переменные,"Код1СДляСистемы"); 
СтруктураЗапроса = Новый Структура("value",Код1СДляИсистемы);	
			
ЗаписьJSON = Новый ЗаписьJSON;ЗаписьJSON.УстановитьСтроку();ЗаписатьJSON(ЗаписьJSON, СтруктураЗапроса);			
СтрокаТелаЗапроса = ЗаписьJSON.Закрыть();
	
HTTPЗапрос = Новый HTTPЗапрос(Соединение.АдресЗапроса);     
HTTPЗапрос.УстановитьТелоИзСтроки(СтрокаТелаЗапроса);
HTTPОтвет = Соединение.HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос); 
РезультатРазбораHTTP = Алгоритм("ПрочитатьОтветСервисаUniversal",HTTPОтвет); 
Если не РезультатРазбораHTTP.Успешно Тогда 
	ВызватьИсключение РезультатРазбораHTTP.Результат;
КонецЕсли;

ТЗ = ЗначениеИзСтрокиВнутр(РезультатРазбораHTTP.Результат); 

//Дополнить данные
Для каждого стр из ТЗ Цикл
	Стр.Система = СистемаGUID;
	Стр.UUID = Стр.Система+Стр.GUID; 
	Стр.ДатаЗагрузки = ДатаЗагрузки;	
КонецЦикла;
	
ПараметрыЗаписиВSQL = DT_DWH.ПараметрыЗаписиВSQL();
ПараметрыЗаписиВSQL.ТЗ = ТЗ; 
ПараметрыЗаписиВSQL.ИмяТаблицы = "НастройкиРассылкиДР"; 
ПараметрыЗаписиВSQL.Ключи.Добавить("UUID"); 
ПараметрыЗаписиВSQL.Ключи.Добавить("ИмяНастройки");
ПараметрыЗаписиВSQL.Ключи.Добавить("ОбъектНастройки");
ПараметрыЗаписиВSQL.СвойстваДляСравнения.Добавить("ВерсияДанных");
ПараметрыЗаписиВSQL.СвойстваДляСравнения.Добавить("ЗначениеНастройки");
ПараметрыЗаписиВSQL.КлючиОбластиУдаления.Вставить("Система",СистемаGUID); //подчищать удаленные настройки	
СтруктураОтвета = DT_DWH.ЗаписатьТЗВSQL(СоединениеDWH,ПараметрыЗаписиВSQL);
	
Обработано = ТЗ.Количество();
Добавлено = СтруктураОтвета.Добавлено;
Обновлено = СтруктураОтвета.Обновлено;  
Удалено = СтруктураОтвета.Удалено;		
		
СтрокаОшибок = СтрокаОшибок + ?(СтрокаОшибок="","",Символы.ПС)+ Система +  " Обработано - "+Обработано+". Добавлено - "+Добавлено+". Обновлено - "+Обновлено+". Удалено - "+Удалено;
	
Если не Отладка Тогда
	УстановитьДатуПоследнейЗагрузки(Система,ЗапросСсылка,ДатаЗагрузки);
КонецЕсли;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'СоединениеDWH',
     'Разделитель': null,
     'ЗначениеСтрока': '',
     'Комментарий': ''
    },
    {
     'Имя': 'Код1СДляСистемы',
     'Разделитель': null,
     'ЗначениеСтрока': 'Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
               |	ОрганизацииДополнительныеРеквизиты.Ссылка КАК Ссылка,
               |	ОрганизацииДополнительныеРеквизиты.Ссылка.ВерсияДанных КАК ВерсияДанных,
               |	""Организации"" КАК ОбъектНастройки,
               |	ОрганизацииДополнительныеРеквизиты.Свойство.Имя КАК ИмяНастройки,
               |	МАКСИМУМ(ВЫРАЗИТЬ(ОрганизацииДополнительныеРеквизиты.Значение КАК Справочник.ЗначенияСвойствОбъектов).Наименование) КАК ЗначениеНастройки
               |ИЗ
               |	Справочник.Организации.ДополнительныеРеквизиты КАК ОрганизацииДополнительныеРеквизиты
               |ГДЕ
               |	ОрганизацииДополнительныеРеквизиты.Свойство.Имя В (""Орг_ПолучатьРассылкуДР"", ""Орг_УчаствоватьВРассылкеДР"")
               |
               |СГРУППИРОВАТЬ ПО
               |	ОрганизацииДополнительныеРеквизиты.Ссылка,
               |	ОрганизацииДополнительныеРеквизиты.Ссылка.ВерсияДанных,
               |	ОрганизацииДополнительныеРеквизиты.Свойство.Имя
               |
               |ОБЪЕДИНИТЬ ВСЕ
               |
               |ВЫБРАТЬ
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Ссылка,
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Ссылка.ВерсияДанных,
               |	""Подразделения"",
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Свойство.Имя,
               |	МАКСИМУМ(ВЫРАЗИТЬ(ПодразделенияОрганизацийДополнительныеРеквизиты.Значение КАК Справочник.ЗначенияСвойствОбъектов).Наименование)
               |ИЗ
               |	Справочник.ПодразделенияОрганизаций.ДополнительныеРеквизиты КАК ПодразделенияОрганизацийДополнительныеРеквизиты
               |ГДЕ
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Свойство.Имя В (""Подр_ПолучатьРассылкуДР"", ""Подр_УчаствоватьВРассылкеДР"")
               |
               |СГРУППИРОВАТЬ ПО
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Ссылка,
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Ссылка.ВерсияДанных,
               |	ПодразделенияОрганизацийДополнительныеРеквизиты.Свойство.Имя
               |
               |ОБЪЕДИНИТЬ ВСЕ
               |
               |ВЫБРАТЬ
               |	СотрудникиДополнительныеРеквизиты.Ссылка,
               |	СотрудникиДополнительныеРеквизиты.Ссылка.ВерсияДанных,
               |	""Сотрудники"",
               |	СотрудникиДополнительныеРеквизиты.Свойство.Имя,
               |	МАКСИМУМ(ВЫРАЗИТЬ(СотрудникиДополнительныеРеквизиты.Значение КАК Справочник.ЗначенияСвойствОбъектов).Наименование)
               |ИЗ
               |	Справочник.Сотрудники.ДополнительныеРеквизиты КАК СотрудникиДополнительныеРеквизиты
               |ГДЕ
               |	СотрудникиДополнительныеРеквизиты.Свойство.Имя В (""Сотр_ПолучатьРассылкуДР"", ""Сотр_УчаствоватьВРассылкеДР"")
               |
               |СГРУППИРОВАТЬ ПО
               |	СотрудникиДополнительныеРеквизиты.Ссылка,
               |	СотрудникиДополнительныеРеквизиты.Ссылка.ВерсияДанных,
               |	СотрудникиДополнительныеРеквизиты.Свойство.Имя";

Выборка = Запрос.Выполнить().Выбрать();
                      
ТЗ = новый ТаблицаЗначений;
ТЗ.Колонки.Добавить("UUID",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(72)));
ТЗ.Колонки.Добавить("Система",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(36)));
ТЗ.Колонки.Добавить("GUID",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(36)));
ТЗ.Колонки.Добавить("ДатаЗагрузки",Новый ОписаниеТипов("Дата"));
ТЗ.Колонки.Добавить("ВерсияДанных",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(12)));
ТЗ.Колонки.Добавить("ОбъектНастройки",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
ТЗ.Колонки.Добавить("ИмяНастройки",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
ТЗ.Колонки.Добавить("ЗначениеНастройки",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
 

Пока Выборка.Следующий() Цикл
    НовСтр = ТЗ.Добавить(); 
    ЗаполнитьЗначенияСвойств(НовСтр,Выборка);       
    НовСтр.GUID = XMLСтрока(Выборка.Ссылка);   
КонецЦикла;
result = ЗначениеВСтрокуВнутр(ТЗ);',
     'Комментарий': ''
    }
   ]
  }
 ]
}
