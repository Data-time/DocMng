{
 'Реквизиты': {
  'Наименование': 'Контроль - ошибки в ключах аналитик',
  'ТекстОбработки': 'Отладка = Ложь;   
ДатаНачалаВыгрузки = ТекущаяДата();
ПочтаПолучателей = "ssmirnov@t-medica.com";
Если Отладка Тогда 
	ПочтаПолучателей = "ssmirnov@t-medica.com";
КонецЕсли;
СимволПереносаСтроки = Символы.ПС + Символы.ВК;
    
    
ТекстОшибок = Новый Массив;

//Добавляем ключи, которые будут анализироваться 
КлючиДляПроверкиКОМ = Соединение.NewObject("Соответствие");          					
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаЗатрат"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаЗатрат")); 					
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаНДС"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаНДС"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиПланированияНоменклатуры"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаПланированияНоменклатуры"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиПланированияПотребностей"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаПланированияПотребностей"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиПланированияСтатейБюджетов"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаПланированияСтатейБюджетов"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиПланированияСтруктуры"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаПланированияСтруктуры")); 
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаПоПартнерам"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаПоПартнерам")); 
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиКонтроляБюджетныхЛимитовРезервов"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаКонтроляБюджетныхЛимитовРезервов"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиКонтроляЗадолженностиПоКонтрагенту"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаКонтроляЗадолженностиПоКонтрагенту"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиКонтроляПоДоговорам"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаКонтроляПоДоговорам"));					
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиПараметровЗакупки"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаПараметровЗакупки")); 
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаНаборов"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаНаборов"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаНоменклатуры"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаНоменклатуры"));
КлючиДляПроверкиКОМ.Вставить(Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"Справочник.КлючиАналитикиУчетаПартий"), 
						Алгоритм("НайтиИдентификаторМетаданныхКОМ",Соединение,"РегистрСведений.АналитикаУчетаПартий"));

						
//удалить пустые значения
Если КлючиДляПроверкиКОМ.Получить(NULL) <> Неопределено Тогда 
	КлючиДляПроверкиКОМ.Удалить(NULL);
КонецЕсли;
						
      
/////////////////////////////////Дубли ключей///////////////////////////////////////////////////      
      
МассивЗапросов = Новый Массив;
Для каждого СтрПроверкиКОМ Из КлючиДляПроверкиКОМ Цикл 
	ЗапросТекст = "ВЫБРАТЬ ПЕРВЫЕ 1
                  |	КлючиСДублями.КлючиАналитик КАК КлючиАналитик
                  |ИЗ
                  |	(ВЫБРАТЬ
                  |		""&ПолноеИмяОбъектаМетаданных"" КАК КлючиАналитик,
                  |		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТекущийСправочник.Ссылка) КАК Количество,
                  |		&ПоляСправочника
                  |	ИЗ
                  |		&ПолноеИмяОбъектаМетаданных КАК ТекущийСправочник
                  |	
                  |	СГРУППИРОВАТЬ ПО
                  |		&ПоляСправочника
                  |	
                  |	ИМЕЮЩИЕ
                  |		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТекущийСправочник.Ссылка) > 1) КАК КлючиСДублями";

	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПолноеИмяОбъектаМетаданных", СтрПроверкиКОМ.Ключ.ПолноеИмя);	 

	ТекущийСправочник = Соединение.ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(СтрПроверкиКОМ.Ключ);

	ШаблонПолей = "ТекущийСправочник.%1";
    МассивПолей = Новый Массив;
	Для каждого Реквизит Из ТекущийСправочник.Реквизиты Цикл
		МассивПолей.Добавить(СтрШаблон(ШаблонПолей, Реквизит.Имя));   
	КонецЦикла;	            
	ПоляСправочника = СтрСоединить(МассивПолей, ",");        
	
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПоляСправочника", ПоляСправочника);	 

	МассивЗапросов.Добавить(ЗапросТекст);
КонецЦикла;   

ЗапросКОМ = Соединение.NewObject("Запрос");
ЗапросКОМ.Текст = СтрСоединить(МассивЗапросов, " ОБЪЕДИНИТЬ ВСЕ ");
ВыборкаКОМ = ЗапросКОМ.Выполнить();
Если НЕ ВыборкаКОМ.Пустой() Тогда  
	ТекстОшибок.Добавить("- Есть дубли ключей аналитик");
КонецЕсли;

/////////////////////////////////Ошибки в РС Аналитик///////////////////////////////////////////////////

МассивЗапросов = Новый Массив;
Для каждого СтрПроверкиКОМ Из КлючиДляПроверкиКОМ Цикл 
	ЗапросТекст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
                |	""&ПолноеИмяОбъектаМетаданных"" КАК РегистрСведений,
                |	""&ИмяОбъектаМетаданных"" КАК ИмяРегистраСведений,
				|	РСАналитик.КлючАналитики КАК КлючАналитики
				|ИЗ
				|	&ПолноеИмяОбъектаМетаданных КАК РСАналитик
				|ГДЕ
				|	НЕ(&ПоляРавенстваИзмеренийАналитикИКлюча)";

	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПолноеИмяОбъектаМетаданных", СтрПроверкиКОМ.Значение.ПолноеИмя);	 
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ИмяОбъектаМетаданных", СтрПроверкиКОМ.Значение.Имя);	 

	ТекущийРС = Соединение.ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(СтрПроверкиКОМ.Значение);

	ШаблонУсловий = "РСАналитик.%1 = РСАналитик.КлючАналитики.%1";
    МассивУсловий = Новый Массив;
	Для каждого Измерение Из ТекущийРС.Измерения Цикл
		МассивУсловий.Добавить(СтрШаблон(ШаблонУсловий, Измерение.Имя));   
	КонецЦикла;	            
	ПоляРавенстваИзмеренийАналитикИКлюча = СтрСоединить(МассивУсловий, " И ");        
	
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПоляРавенстваИзмеренийАналитикИКлюча", ПоляРавенстваИзмеренийАналитикИКлюча);	 

	МассивЗапросов.Добавить(ЗапросТекст);
КонецЦикла;   

ЗапросКОМ = Соединение.NewObject("Запрос");
ЗапросКОМ.Текст = СтрСоединить(МассивЗапросов, " ОБЪЕДИНИТЬ ВСЕ ");
ВыборкаКОМ = ЗапросКОМ.Выполнить();
Если НЕ ВыборкаКОМ.Пустой() Тогда  
	ТекстОшибок.Добавить("- Есть неправильные записи о ключах аналитик в РС");
КонецЕсли;
  
/////////////////////////////////Отправка письма, если есть ошибки/////////////////////////////////////
Если ТекстОшибок.Количество() > 0 Тогда       
	
    
	ТемаСообщения = "" + Система + " - есть ошибки в ключах аналитик на " + Формат(ДатаНачалаВыгрузки,"ДФ=dd.MM.yyyy");
	ТекстСообщения = "Необходимо сделать исправление ошибок обработкой: e1cib/data/Справочник.Обработки?ref=a12cef295ee2b5a311ed0d878a85324c" + СимволПереносаСтроки
	+ "в некоторых системах, например ERP, в списке ключей в меню ЕЩЕ есть специальная кнопка исправления"
	+ СтрСоединить(ТекстОшибок, СимволПереносаСтроки);

	ГуидУчетнойЗаписиПочты = "567e3146-123f-11ed-a12c-ef295ee2b5a3";
	Алгоритм("ОтправитьEmail",ЗапросСсылка,ПочтаПолучателей,ТемаСообщения,ТекстСообщения,ТипТекстаПочтовогоСообщения.РазмеченныйТекст,ГуидУчетнойЗаписиПочты);	      
	СтрокаОшибок = СтрокаОшибок + "Отправлено письмо о необходимости исправить ключи аналитик" + СимволПереносаСтроки;
КонецЕсли;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': []
  }
 ]
}
